@{
    ViewData["Title"] = "Danh sách chấm bài"; 
}

@section Links {
    <style>
        .view-detail {
            cursor: pointer;
            text-decoration: none;
        }

        #sourceCodeEditor {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
        }

        #resultContent {
            width: 100%;
            height: 300px;
            resize: vertical;
        }

        .modal-xl {
            max-width: 90%;
        }

        .title {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            width: 100%;
            text-align: center;
            font-weight: 700;
        }

        .avatar-img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 50%;
        }
    </style>
}

<div id="codepad" class="m-5 flex-center flex-column">
    <h1 class="title text-center">
        <b>DANH&nbsp;SÁCH CHẤM&nbsp;BÀI</b>
    </h1>

    <div class="container mt-3 mb-3 table-responsive list">
        <table id="table-data" class="table table-sm table-hover table-border table-striped ml-5 mr-3">
            <thead>
                <tr class="table-dark">
                    <th>Thời gian</th>
                    <th></th>
                    <th>Người dùng</th>
                    <th>Mã bài</th>
                    <th>Tên bài</th>
                    <th>Testcase Đúng</th>
                    <th>Điểm</th>
                    <th>Trạng thái</th>
                    <th>Ngôn ngữ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Modal for Viewing Details -->
<div class="modal fade" id="markingDetailModal" tabindex="-1" aria-labelledby="markingDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="markingDetailModalLabel">Chi tiết bài nộp</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>Mã nguồn:</h6>
                        <div id="sourceCodeEditor"></div>
                    </div>
                    <div class="col-md-4">
                        <h6 class="mt-3">Kết quả thực thi:</h6>
                        <textarea id="resultContent" class="form-control" readonly></textarea>
                        <a id="viewDetailTestcase" class="btn btn-outline-info mt-3 text-lg-end" href="#">XEM CHI TIẾT</a>
                    </div>
                    
                </div>
                
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="~/lib/ace-builds/src-min-noconflict/ext-language_tools.js"></script>
    <script>
        function getProgramLanguageMode(proLanguageCode) {
            if (proLanguageCode == "cpp")
                return "ace/mode/c_cpp";
            else if (proLanguageCode == "py")
                return "ace/mode/python";
            else if (proLanguageCode == "pas")
                return "ace/mode/pascal";
            else
                return "ace/mode/javascript";
        }
        var table = $('#table-data').DataTable({
            "processing": true,
            "serverSide": true,
            "searching": true,
            "ajax": {
                "url": '@Url.Action("_GetList", "Marking")',
                "data": function (d) {
                    d.keyword = $('input[type="search"]').val();
                    d.userId = `@ViewBag.UserId` || null; // Pass userId if available`
                    d.exerciseId = `@ViewBag.ExerciseId` || null; // Pass exerciseId if available
                },
                "type": "POST",
                "dataSrc": function (json) {
                    return json.data;
                }
            },
            "pageLength": 10,
            "lengthMenu": [10, 25, 50, 100],
            "order": [[0, "desc"]], // Default sort by markingDate descending
            "columns": [
                { "data": "markingDate" },
                {
                        "data": "avatar",
                        "render": function (data, type, row) {
                            if (!data) {
                                return `<a href="/userinfo/details/${row.userId}">
                                            <img src="/assets/images/avartardefault.jpg" class="avatar-img" alt="Default Avatar"  loading="lazy"/>
                                        </a>`;
                            }
                            // Tạo blob URL
                            const byteCharacters = atob(data);
                            const byteNumbers = new Array(byteCharacters.length);
                            for (let i = 0; i < byteCharacters.length; i++) {
                                byteNumbers[i] = byteCharacters.charCodeAt(i);
                            }
                            const byteArray = new Uint8Array(byteNumbers);
                            const blob = new Blob([byteArray], { type: 'image/jpeg' });
                            const blobUrl = URL.createObjectURL(blob);

                            return `<a href="/userinfo/details/${row.userId}">
                                        <img src="${blobUrl}" class="avatar-img" alt="Avatar" loading="lazy"/>
                                    </a>`;
                        },
                        "orderable": false // Avatar column is not sortable
                    },
                {
                    "data": "userFullname",
                    "render": function (data, type, row) {
                        return `<a href="/userinfo/details/${row.userId}">${data}</a>`;
                    }
                },
                {
                    "data": "exerciseCode",
                    "render": function (data, type, row) {
                        return `<a href="/Exercise/Code/${row.exerciseId}">${data}</a>`;
                    }
                },
                {
                    "data": "exerciseName",
                    "render": function (data, type, row) {
                        return `<a href="/Exercise/Code/${row.exerciseId}">${data}</a>`;
                    }
                },
                { "data": "correctTestNumber" },
                { "data": "score" },
                {
                    "data": "status",
                    "render": function (data, type, row) {
                        if (data === 'Passed') {
                            return `<b onclick="viewDetail(${row.markingId})" class="view-detail badge bg-success text-dark">${data}</b>`;
                        } else if (data === 'Error') {
                            return `<b onclick="viewDetail(${row.markingId})" class="view-detail badge bg-danger">${data}</b>`;
                        } else {
                            return `<b onclick="viewDetail(${row.markingId})" class="view-detail badge bg-warning">${data}</b>`;
                        }
                    }
                },
                { "data": "programLanguageName" }
            ],
            "language": {
                "emptyTable": "Không có dữ liệu",
                "info": "Hiển thị _START_ đến _END_ trong tổng số _TOTAL_ mục",
                "infoEmpty": "Hiển thị 0 đến 0 trong tổng số 0 mục",
                "infoFiltered": "(được lọc từ tổng số _MAX_ mục)",
                "lengthMenu": "Hiển thị _MENU_ mục",
                "search": "Tìm kiếm:",
                "zeroRecords": "Không tìm thấy kết quả"
            },
        });

        // Initialize Ace Editor
        var editor = ace.edit("sourceCodeEditor");
        editor.setTheme("ace/theme/monokai");
        editor.setReadOnly(true);
        editor.setOptions({
            fontSize: "14px",
            showPrintMargin: false
        });
        $('#markingDetailModal').on('hidden.bs.modal', function () {
            editor.setValue('');
            $('#resultContent').val('');
        });
        function viewDetail(id) {
            $.ajax({
                url: '@Url.Action("Detail", "Marking")',
                type: 'GET',
                data: { id: id },
                success: function (response) {
                    if (response.status && response.data) {
                        // Set source code in Ace Editor    
                        var sourceCode = response.data.sourceCode || '';
                        var language = getProgramLanguageMode(response.data.programLanguageName);

                        editor.setTheme(response.data.theme);
                        editor.session.setMode(language);
                        editor.setValue(sourceCode, -1); // -1 to move cursor to start
                        // Set result content in textarea
                        $('#resultContent').val(response.data.resultContent || '');
                        $('#viewDetailTestcase').attr('href', `/Marking/ViewDetailMarking/${id}`);
                        // Show the modal
                        var modal = new bootstrap.Modal(document.getElementById('markingDetailModal'));
                        modal.show();
                    } else {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'error',
                            title: response.error || 'Không thể tải chi tiết bài nộp',
                            showConfirmButton: false,
                            timer: 3000
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching detail:', error);
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: 'error',
                        title: 'Lỗi khi tải chi tiết bài nộp',
                        showConfirmButton: false,
                        timer: 3000
                    });
                }
            });
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        $(document).ready(function () {
        // Initialize SignalR connection
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/markingHub")
                .configureLogging(signalR.LogLevel.Information)
                .build();

            // Start SignalR connection
            async function startSignalR() {
                try {
                    await connection.start();
                    console.log("SignalR Connected.");
                } catch (err) {
                    console.error("SignalR Connection Error: ", err);
                    setTimeout(startSignalR, 5000); // Retry after 5 seconds
                }
            }
            startSignalR();
            // Handle connection closed event
            connection.onclose(async () => {
                console.warn("SignalR connection closed. Attempting to reconnect...");
                await startSignalR();
            });

            connection.on("AnnouncementToReload", function (result) {
                if(result){
                    table.ajax.reload(null, false);
                }
            });
        });
    </script>

}